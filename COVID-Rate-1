-- 02_vw_covid_typed.sql
-- Purpose:
-- Convert raw RESP-NET fields into analysis-ready types:
--  - _YearMonth (YYYYMM) -> month_date (DATE)
--  - MonthlyRate -> monthly_rate (FLOAT64)
--  - Add QA flags so downstream dashboards can filter reliably.

CREATE OR REPLACE VIEW
`project2-482922.Covid_Rates.vw_covid_typed` AS
SELECT
  State,
  Season,
  AgeCategory_Legend,
  Sex_Label,
  Race_Label,
  Type,

  -- Convert YYYYMM (e.g., 202205) into a proper month date (2022-05-01)
  SAFE.PARSE_DATE(
    '%Y%m',
    CAST(CAST(_YearMonth AS INT64) AS STRING)
  ) AS month_date,

  SAFE_CAST(MonthlyRate AS FLOAT64) AS monthly_rate,

  -- QA flags (document issues without silently dropping data)
  CASE WHEN _YearMonth IS NULL THEN 1 ELSE 0 END AS flag_missing_yearmonth,
  CASE
    WHEN SAFE.PARSE_DATE('%Y%m', CAST(CAST(_YearMonth AS INT64) AS STRING)) IS NULL
    THEN 1 ELSE 0
  END AS flag_bad_yearmonth,
  CASE WHEN MonthlyRate IS NULL THEN 1 ELSE 0 END AS flag_missing_rate,
  CASE WHEN SAFE_CAST(MonthlyRate AS FLOAT64) < 0 THEN 1 ELSE 0 END AS flag_negative_rate
FROM `project2-482922.Covid_Rates.raw_covid`;
