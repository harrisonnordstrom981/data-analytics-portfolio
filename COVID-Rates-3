-- 04_vw_covid_metrics.sql
-- Purpose:
-- Metrics layer for time-series analysis:
--  - Lagged rates
--  - Month-over-month (MoM) change + percent change
--  - Rolling averages (3mo, 6mo)
--  - Peak-month identification (within each group)
--
-- This view is designed to feed Tableau dashboards directly.

CREATE OR REPLACE VIEW
`project2-482922.Covid_Rates.vw_covid_metrics` AS

WITH base AS (
  SELECT
    State,
    Season,
    AgeCategory_Legend,
    Sex_Label,
    Race_Label,
    Type,
    month_date,
    monthly_rate
  FROM `project2-482922.Covid_Rates.vw_covid_clean`
),

metrics AS (
  SELECT
    *,

    -- Prior month value for the same group
    LAG(monthly_rate) OVER (
      PARTITION BY State, AgeCategory_Legend, Sex_Label, Race_Label, Type
      ORDER BY month_date
    ) AS rate_prev_month,

    -- MoM absolute change
    monthly_rate - LAG(monthly_rate) OVER (
      PARTITION BY State, AgeCategory_Legend, Sex_Label, Race_Label, Type
      ORDER BY month_date
    ) AS mom_change,

    -- MoM percent change (safe divide)
    SAFE_DIVIDE(
      monthly_rate - LAG(monthly_rate) OVER (
        PARTITION BY State, AgeCategory_Legend, Sex_Label, Race_Label, Type
        ORDER BY month_date
      ),
      LAG(monthly_rate) OVER (
        PARTITION BY State, AgeCategory_Legend, Sex_Label, Race_Label, Type
        ORDER BY month_date
      )
    ) AS mom_pct_change,

    -- Rolling averages (signal smoothing)
    AVG(monthly_rate) OVER (
      PARTITION BY State, AgeCategory_Legend, Sex_Label, Race_Label, Type
      ORDER BY month_date
      ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
    ) AS rolling_avg_3mo,

    AVG(monthly_rate) OVER (
      PARTITION BY State, AgeCategory_Legend, Sex_Label, Race_Label, Type
      ORDER BY month_date
      ROWS BETWEEN 5 PRECEDING AND CURRENT ROW
    ) AS rolling_avg_6mo,

    -- Peak month rank (ties allowed)
    RANK() OVER (
      PARTITION BY State, AgeCategory_Legend, Sex_Label, Race_Label, Type
      ORDER BY monthly_rate DESC
    ) AS peak_rank_all_time
  FROM base
)

SELECT
  *,
  CASE WHEN peak_rank_all_time = 1 THEN 1 ELSE 0 END AS is_peak_month_all_time,
  FORMAT_DATE('%Y-%m', month_date) AS year_month_label
FROM metrics;
